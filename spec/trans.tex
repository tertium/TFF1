\section{Translations} \label{sec:trans}

\subsection{Encoding into a Many-Sorted Logic} \label{ssec:tff0}

We describe here a simple translation from TFF1 to a traditional
many-sorted first-order logic. More sophisticated encodings which
preserve selected types by translating them into separate sorts,
or do not change the propositional structure of encoded formulas
are described in \cite{leino10tacas,bobot11frocos}.
Notice that both papers assume preliminary elimination
of ghost type arguments (cf.~Section~\ref{ssec:ghost});
the latter also assumes preliminary type skolemization
(cf.~Section~\ref{ssec:skol}).

Let $\Delta$ be a set of TFF sentences, that is, closed and well-typed
formulas. We construct an equisatisfiable set of monomorphic two-sorted
formulas $\MON(\Delta)$ as follows.
%
We introduce two sorts, $\typ$ and $\und$.
To every type variable $\alpha$ in $\Delta$ we assign
a fresh variable $\hat{\alpha}$ of sort $\typ$.
To every ordinary variable $u$ we assign
a fresh variable $\hat{u}$ of sort $\und$.
To every type constructor $K$ of arity $n$ we assign
a function symbol $\hat{K}$ of sort signature $\typ^n \to \typ$.
To every function symbol $f$ of type signature
$\forall \alpha_1\dots\alpha_n \,.\, T_1 \times \dots \times T_m \to T$
we assign a function symbol $\hat{f}$ of sort signature
$\typ^n \times \und^m \to \und$.
To every predicate symbol $p$ of type signature
$\forall \alpha_1\dots\alpha_n \,.\, T_1 \times \dots \times T_m \to \omicron$
we assign a predicate symbol $\hat{p}$ of sort signature
$\typ^n \times \und^m \to \omicron$.
Finally, we add a new predicate symbol $\typeof$ of sort signature
$\und \times \typ$.

The $\MON$ transformation translates TFF types, terms, and formulas
according to the following equations ($\bar{S}$ and $\bar{t}$ denote
sequences of types and terms, respectively):
\begin{align*}
\MON(\alpha) &\eqdef \hat{\alpha} &
\MON(K(\bar{S})) &\eqdef \hat{K}(\MON(\bar{S})) \\
\MON(u) &\eqdef \hat{u} &
\MON(f(\bar{S},\bar{t})) &\eqdef \hat{f}(\MON(\bar{S}),\MON(\bar{t})) \\
\MON(t_1 \approx t_2) &\eqdef \MON(t_1) \approx \MON(t_2) &
\MON(p(\bar{S},\bar{t})) &\eqdef \hat{p}(\MON(\bar{S}),\MON(\bar{t})) \\
\MON(\lnot F) &\eqdef \lnot\, \MON(F) &
\MON(F \land G) &\eqdef \MON(F) \land\, \MON(G) \\
\MON(\forall u \ty T .\, F) &\eqdef
\forall \hat{u} \,.\, \typeof(\hat{u}, \MON(T)) \limp \MON(F) &
\MON(\forall \alpha \,.\, F) &\eqdef
\forall \hat{\alpha} \,.\, \MON(F)
\end{align*}

\newcommand{\AxD}{\text{\sc Ax}_{\Delta}}
\newcommand{\Inh}{\text{\sc Inh}}
\newcommand{\Dom}{\mathrm{Dom}}

Consider a function symbol $f$ with type signature
$\forall \alpha_1\dots\alpha_n \,.\, T_1 \times \dots \times T_m \to T$.
The {\em typing axiom\/} for $f$ is a formula
$$
\forall \hat{\alpha}_1\dots\hat{\alpha}_n \,.\,
\forall \hat{v}_1\dots\hat{v}_m \,.\,
\typeof(\hat{f}(\hat{\alpha}_1,\dots,\hat{\alpha}_n,
\hat{v}_1,\dots,\hat{v}_m), \MON(T)).
$$
We denote with $\AxD$ the set of typing axioms
for all function symbols occurring in $\Delta$.
The {\em inhabitance axiom}, denoted $\Inh$,
is a formula
$\forall \hat{\alpha} \exists \hat{u} \,.\,
\typeof(\hat{u},\hat{\alpha}).$
Then we define
$$
\MON(\Delta) \eqdef \{ \MON(F) \vb F \in \Delta \} \cup
\AxD \cup \{ \Inh \}.
$$

It is easy to see that $\MON$ converts TFF types into well-formed
terms of sort $\typ$, TFF terms into well-formed terms of sort $\und$,
and TFF formulas (not necessarily well-typed) into well-formed formulas.

\begin{theorem}[Soundness of $\MON$] \label{thm:mon_sound}
If a set of sentences $\Delta$ is satisfiable in TFF,
then $\MON(\Delta)$ is satisfiable in classical
many-sorted first-order logic with equality.
\end{theorem}
\begin{proof}
Let $\cM$ be a model of $\Delta$.
We construct an interpretation $\cI$ of $\MON(\Delta)$ as follows.
Let us denote with $\sorts$ and $\univ$, respectively,
the set of domains and the universe in $\cM$.
In $\cI$, we define the domain of sort $\typ$ to be $\sorts$
and the domain of sort $\und$ to be $\univ$.
Every function symbol $\hat{K}$ (function symbol $\hat{f}$,
predicate symbol $\hat{p}$) is interpreted in $\cI$
exactly as the type constructor $K$ (function symbol $f$,
predicate symbol $p$) in $\cM$.
The predicate symbol $\typeof$ is interpreted as the membership relation.
%This concludes the definition of interpretation $\cI$.

We are going to show that for every type $S$, term $t$,
and formula $F$ occurring in $\Delta$,
for every variable valuation $\nu$ in $\cI$, we have
\begin{align*}
\llb \MON(S) \rrb^\cI_{\nu} &= \llb S \rrb^\cM_{\theta} &
\llb \MON(t) \rrb^\cI_{\nu} &= \llb t \rrb^\cM_{\theta,\xi} &
\llb \MON(F) \rrb^\cI_{\nu} &= \llb F \rrb^\cM_{\theta,\xi}
\end{align*}
where $\theta(\alpha) \eqdef \nu(\hat{\alpha})$ and
$\xi(u) \eqdef \nu(\hat{u})$ for every
type variable $\alpha$ and every variable $u$.
%
We prove these equalities by induction on the structure
of types, terms, and formulas. The only non-trivial case is
that of a quantified formula, $\forall u \ty T .\, F$.
It is easy to see that any $a \in \univ$ belongs
to $\llb T \rrb^\cM_\theta$ if and only if
$\llb \typeof(\hat{u},\MON(T)) \rrb^\cI_{\nu[\hat{u}\,\mapsto\,a]}$
holds. Indeed, the latter is equivalent to
$a \in \llb \MON(T) \rrb^\cI_{\nu[\hat{u}\,\mapsto\,a]}$.
Since $\nu$ and $\nu[\hat{u} \mapsto a]$ produce the same
$\theta$ in $\cM$,
$\llb \MON(T) \rrb^\cI_{\nu[\hat{u}\,\mapsto\,a]} =
\llb T \rrb^\cM_\theta$.
Then
$\llb \forall \hat{u} \,.\, \typeof(\hat{u},\MON(T))
\limp \MON(F) \rrb^\cI_{\nu}$ is exactly
$\llb \forall u \ty T .\, F \rrb^\cM_{\theta,\xi}$
by induction hypothesis.

Now we only have to check that the typing axioms
$\AxD$ and the inhabitance axiom $\Inh$ hold in $\cI$.
This immediately follows from the definition of
interpretation in TFF and the first equality above.
\qed
\end{proof}

\begin{theorem}[Completeness of $\MON$] \label{thm:mon_compl}
Given a set of sentences $\Delta$, if $\MON(\Delta)$
is satisfiable in classical many-sorted first-order logic
with equality, then $\Delta$ is satisfiable in TFF.
\end{theorem}
\begin{proof}
Let $\cM$ be a model of $\MON(\Delta)$. Let us replace every element $d$ in
the domain of $\typ$ by the set $D = \{\la a,d \ra \,|\, \typeof^\cM(a,d)\}$
and update correspondingly the interpretations of type constructors
and function and predicate symbols in $\cM$.
We can safely perform this substitution, because the inhabitance
axiom $\Inh$ holds in $\cM$, and therefore every such set is non-empty
and there is one-to-one correspondence with the initial domain of $\typ$.
In the model $\cM$ thus modified, $\typeof^\cM(a,D)$ holds if and only if
$D$ contains a pair $\la a,d \ra$.
%
Below, $\pi_1$ and $\pi_2$ stand for the first and the second projection
of a pair, respectively.

We construct an interpretation $\cI$ of $\Delta$ as follows.
We define the set of domains $\sorts$ to be the new domain
of $\typ$ in $\cM$. As usual, $\univ$ denotes the union
of all domains in $\sorts$. Notice that some elements of
the domain of $\und$ may not appear in any pair in $\univ$.

The symbols of $\Delta$ are interpreted in $\cI$
according to the following equations:
\begin{align*}
K^\cI(D_1,\dots,D_n) &\eqdef \hat{K}^\cM(D_1,\dots,D_n) \\
f^\cI(D_1,\dots,D_n,\la a_1,d_1 \ra,\dots,\la a_m,d_m \ra) &\eqdef
\la \hat{f}^\cM(D_1,\dots,D_n,a_1,\dots,a_m), d \ra \\
p^\cI(D_1,\dots,D_n,\la a_1,d_1 \ra,\dots,\la a_m,d_m \ra) &\eqdef
\hat{p}^\cM(D_1,\dots,D_n,a_1,\dots,a_m)
\end{align*}
where
$K$ is of arity $n$,
the signature of $p$ is
$\forall \alpha_1\dots\alpha_n \,.\, T_1 \times \dots \times T_m \to
\omicron$,
the signature of $f$ is
$\forall \alpha_1\dots\alpha_n \,.\, T_1 \times \dots \times T_m \to T$,
and $d$ is the fixed second coordinate of pairs in the domain
$D = \llb \MON(T) \rrb^\cM_{[\hat{\alpha}_1\,\mapsto\,D_1,\dots,
\hat{\alpha_n}\,\mapsto\,D_n]} =
\llb T \rrb^\cI_{[\alpha_1\,\mapsto\,D_1,\dots,\alpha_n\,\mapsto\,D_n]}$.
Since the typing axioms $\AxD$ hold in $\cM$, we have
$\typeof^\cM(f^\cM(D_1,\dots,D_n,a_1,\dots,a_m), D)$,
and therefore, the result of $f^\cI$ belongs indeed to $D$.
This concludes the definition of $\cI$.

Given a type context $\gamma$, a type valuation $\theta$,
and a variable valuation $\xi$, we say that they are admissible
for a formula $F$, whenever the following conditions are satisfied:
\begin{itemize}
\item $F$ is well-typed in context $\gamma$;
\item for every variable $v$ free in $F$, no type variable
occurring in $\gamma(v)$ is bound in $F$;
\item for every variable $v$ free in $F$, $\xi(v) \in \evalT{\gamma(v)}$.
\end{itemize}

Let us show that for every type $S$, term $t$, and formula $F$,
and for every triple $\gamma$, $\theta$, $\xi$ admissible for $F$,
we have
\begin{align*}
\evalT{S} &= \llb \MON(S) \rrb^\cM_{\nu} &
\pi_1(\eval{t}) &= \llb \MON(t) \rrb^\cM_{\nu} &
\eval{F} &= \llb \MON(F) \rrb^\cM_{\nu}
\end{align*}
where $\nu(\hat{\alpha}) \eqdef \theta(\alpha)$ and
$\nu(\hat{u}) \eqdef \pi_1(\xi(u))$
for every type variable $\alpha$ and variable $u$.

The proof goes by induction on the structure of types, terms, and formulas.
We have three non-trivial cases: equality, quantification over an ordinary
variable, and quantification over a type variable.

Let $F$ be an equality $t_1 \approx t_2$.
Let $\la a_1, d_1 \ra$ be $\eval{t_1}$ and $\la a_2, d_2 \ra$ be $\eval{t_2}$.
By induction hypothesis, $\llb \MON(t_1) \rrb^\cM_{\nu} = a_1$ and
$\llb \MON(t_2) \rrb^\cM_{\nu} = a_2$. Let us show that $d_1 = d_2$.
By assumption, $F$ is well-typed in context $\gamma$.
Thus, $\gamma\,\vdash t_1 \ty S$ and $\gamma\,\vdash t_2 \ty S$
for some type $S$.
If $t_1$ is a variable $v$, then
$\eval{t_1} = \xi(v) \in \eval{\gamma(v)} = \evalT{S}$.
Let $t_1$ be a function application $f(S_1,\dots,S_n,s_1,\dots,s_m)$,
where $f \ty
\forall \alpha_1\dots\alpha_n \,.\, T_1 \times \dots \times T_m \to T$.
Let $D_i = \evalT{S_i}$ for every $i \in [1,n]$.
Then $S = T[S_1/\alpha_1,\dots,S_n/\alpha_n]$ and
$\evalT{S} = \llb T \rrb^\cI_{[\alpha_1 \,\mapsto\, D_1,\dots,
\alpha_n \,\mapsto\, D_n]}$.
By construction of $\cI$, $\eval{t_1} \in \evalT{S}$.
By the same argument, $\eval{t_2} \in \evalT{S}$.
Hence, $d_1 = d_2$ and $\eval{F} = \llb \MON(F) \rrb^\cM_{\nu}$.

Let $F$ be a quantified formula $\forall u \ty T .\, G$.
We must show that for every pair $\la a,d \ra$ in $\evalT{T}$, we have
$\typeof^\cM(a, \llb \MON(T) \rrb^\cM_{\nu[\hat{u}\,\mapsto\,a]})$,
and vice versa, for every $a$ in the domain of $\und$, if
$\typeof^\cM(a, \llb \MON(T) \rrb^\cM_{\nu[\hat{u}\,\mapsto\,a]})$
holds, then there exists some $d$ such that $\la a,d \ra \in
\evalT{T}$.
%
Since ordinary variables do not occur in types,
$\llb \MON(T) \rrb^\cM_{\nu[\hat{u}\,\mapsto\,a]} =
\llb T \rrb^\cI_\theta$.
By construction of $\cM$,
$\typeof^\cM(a, \llb T \rrb^\cI_\theta)$
holds if and only if there is some $d'$ such that
$\la a,d' \ra \in \llb T \rrb^\cI_\theta$.
%
Now, notice that the triple $\gamma[u \mapsto T],
\theta,\xi[u \mapsto \la a,d \ra]$ is admissible for $G$.
Indeed, $G$ is well-typed in $\gamma[u \mapsto T]$,
and for every $v \in \FV(G)$, we have
$\xi[u \mapsto \la a,d \ra](v) \in \evalT{\gamma[u \mapsto T](v)}$.
Also, if $T$ contains a type variable $\beta$ bound in $G$,
then $\beta$ is both free and bound in $F$, which violates
the no-clash assumption we have made.
%
Then, by induction hypothesis, $\eval{\forall u \ty T .\, G}$
is exactly $\llb \forall \hat{u} \,.\, \typeof(\hat{u},\MON(T))
\limp \MON(G) \rrb^\cM_{\nu}$.

Let $F$ be a quantified formula $\forall \alpha \,.\, G$.
Let $D$ be an element of $\sorts$. Under the no-clash assumption,
formula $G$ is well-typed in context $\gamma$, and for all
$v \in \FV(G) = \FV(F)$, we have
$\evalG{\gamma(v)}_{\theta[\alpha\,\mapsto\,D]} = \evalT{\gamma(v)}$.
Then $\eval{F} = \llb \MON(F) \rrb^\cM_{\nu}$ by induction hypothesis.
\qed
\end{proof}

\newpage

\subsection{Elimination of Ghost Type Arguments} \label{ssec:ghost}
\subsection{Type Skolemization} \label{ssec:skol}


